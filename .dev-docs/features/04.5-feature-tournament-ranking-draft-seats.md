# Feature 4.5: Tournament Ranking with Draft Seats & Points System

## Objective

Enhance the tournament system to support MTG draft format with:
1. Draft seat assignment during tournament creation
2. First round pairings based on draft seat positions (pairing players across the table)
3. Points-based ranking system (3 points for win, 2 for draw, 1 for loss)
4. Round timers to track match duration and enable automatic draws
5. Tournament winner determination based on point totals

## Background

The current tournament system uses Swiss pairings with win/loss records. For MTG draft tournaments, we need:
- **Draft Seats:** Players sit around a table in assigned seats (typically 8 players)
- **First Round Pairing:** Players face the person directly across from them (seat 1 vs seat 5, seat 2 vs seat 6, etc.)
- **Points System:** More granular scoring than simple win/loss
- **Round Timers:** Track time remaining in each round to enable automatic draws when time expires

## Implementation Steps

### Step 1: Database Migration

**File:** `.dev-docs/DATABASE_MIGRATION_draft_seats_and_timers.md`

Create migration to add:
1. `tournament_participants` table to track draft seats
2. `round_duration_minutes` column to `tournaments` table
3. `started_at` column to `matches` table

**SQL Script:**
```sql
-- Create tournament_participants table
CREATE TABLE IF NOT EXISTS tournament_participants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tournament_id UUID NOT NULL REFERENCES tournaments(id) ON DELETE CASCADE,
  player_id UUID NOT NULL REFERENCES players(id) ON DELETE CASCADE,
  draft_seat INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(tournament_id, player_id),
  UNIQUE(tournament_id, draft_seat),
  CHECK(draft_seat >= 1)
);

-- Add indexes
CREATE INDEX idx_tournament_participants_tournament ON tournament_participants(tournament_id);
CREATE INDEX idx_tournament_participants_player ON tournament_participants(player_id);

-- Add round_duration_minutes to tournaments
ALTER TABLE tournaments
ADD COLUMN IF NOT EXISTS round_duration_minutes INTEGER DEFAULT 50;

-- Add started_at to matches
ALTER TABLE matches
ADD COLUMN IF NOT EXISTS started_at TIMESTAMP;
```

### Step 2: Update Tournament Creation Flow

**File:** `app/tournament/actions.ts`

Modify `createTournament` function:

1. **Assign Draft Seats:**
   - After creating tournament, assign draft seats to each player
   - Seats are numbered 1 through N (where N = number of players)
   - For 8 players: seats 1-4 on one side, seats 5-8 on opposite side
   - Store in `tournament_participants` table

2. **Generate Round 1 Pairings Based on Draft Seats:**
   - Instead of using Swiss pairings for Round 1, pair based on draft seats
   - Formula for 8-player draft:
     - Seat 1 pairs with Seat 5
     - Seat 2 pairs with Seat 6
     - Seat 3 pairs with Seat 7
     - Seat 4 pairs with Seat 8
   - General formula: For N players, seat K pairs with seat (K + N/2) mod N (for K <= N/2)
   - For odd numbers, handle bye appropriately

3. **Set Round Start Time:**
   - When creating Round 1 matches, set `started_at` to current timestamp
   - This enables round timer tracking

**Key Changes:**
```typescript
// After creating tournament, assign draft seats
const shuffledPlayerIds = [...playerIds].sort(() => Math.random() - 0.5);
for (let i = 0; i < shuffledPlayerIds.length; i++) {
  await supabase.from('tournament_participants').insert({
    tournament_id: tournament.id,
    player_id: shuffledPlayerIds[i],
    draft_seat: i + 1,
  });
}

// Generate Round 1 pairings based on draft seats
const numPlayers = playerIds.length;
const pairings: Array<{ player1: string; player2?: string }> = [];

for (let i = 0; i < Math.floor(numPlayers / 2); i++) {
  const seat1 = i + 1;
  const seat2 = i + 1 + Math.floor(numPlayers / 2);
  
  const player1 = shuffledPlayerIds[seat1 - 1];
  const player2 = shuffledPlayerIds[seat2 - 1];
  
  pairings.push({ player1, player2 });
}

// Handle bye for odd number of players
if (numPlayers % 2 === 1) {
  const byeSeat = numPlayers;
  const byePlayer = shuffledPlayerIds[byeSeat - 1];
  pairings.push({ player1: byePlayer });
}

// Create matches with started_at timestamp
const roundStartTime = new Date().toISOString();
for (const pairing of pairings) {
  await supabase.from('matches').insert({
    tournament_id: tournament.id,
    round_number: 1,
    game_type: format,
    started_at: roundStartTime,
  });
  // ... create participants
}
```

### Step 3: Update Standings Calculation

**File:** `app/tournament/actions.ts`

Modify `generateNextRound` function to calculate standings using points:

**Current:** Counts wins, losses, draws
**New:** Calculate points (3 for win, 2 for draw, 1 for loss)

```typescript
// Calculate standings with points
const standingsMap = new Map<string, { 
  wins: number; 
  losses: number; 
  draws: number;
  points: number;
}>();

allParticipants?.forEach((p) => {
  if (!standingsMap.has(p.player_id)) {
    standingsMap.set(p.player_id, { wins: 0, losses: 0, draws: 0, points: 0 });
  }

  const standing = standingsMap.get(p.player_id)!;
  if (p.result === 'win') {
    standing.wins++;
    standing.points += 3;
  } else if (p.result === 'loss') {
    standing.losses++;
    standing.points += 1;
  } else if (p.result === 'draw') {
    standing.draws++;
    standing.points += 2;
  }
});

// Convert to array format for Swiss pairing
// Note: Swiss library uses wins/losses/draws, but we'll sort by points first
const standings = Array.from(standingsMap.entries())
  .map(([id, stats]) => ({ id, ...stats }))
  .sort((a, b) => {
    // Primary sort: points (descending)
    if (b.points !== a.points) return b.points - a.points;
    // Secondary sort: wins (descending)
    if (b.wins !== a.wins) return b.wins - a.wins;
    // Tertiary sort: losses (ascending)
    return a.losses - b.losses;
  });
```

### Step 4: Add Round Timer UI

**File:** `app/tournament/[id]/page.tsx`

Add round timer display to tournament bracket page:

1. **Calculate Time Remaining:**
   - Fetch tournament `round_duration_minutes`
   - Fetch current round matches `started_at`
   - Calculate: `timeRemaining = round_duration_minutes - (now - started_at)`

2. **Display Timer:**
   - Show countdown timer for current round
   - Format: "45:23 remaining" or "Round Complete"
   - Color coding:
     - Green: > 10 minutes remaining
     - Yellow: 5-10 minutes remaining
     - Red: < 5 minutes remaining

3. **Timer Display Only (No Auto-Draws):**
   - Timer is informational only - shows time remaining
   - When timer reaches 0, display "Time Expired" but take no automatic action
   - Players can still manually report results (win/loss/draw) even after time expires
   - This prevents accidental draws if players forgot to report their results

**Timer Setup:**
- `round_duration_minutes` is set at **tournament creation** (defines how long each round lasts)
- `started_at` is set when **"Start Round" button is clicked** (not automatically)
- Timer can be paused/resumed using "Pause" and "Resume" buttons

**Implementation:**
```typescript
// Server Component: Calculate time remaining
const { data: tournament } = await supabase
  .from('tournaments')
  .select('round_duration_minutes')
  .eq('id', tournamentId)
  .single();

const { data: currentRoundMatch } = await supabase
  .from('matches')
  .select('started_at, paused_at, total_paused_seconds')
  .eq('tournament_id', tournamentId)
  .eq('round_number', currentRound)
  .limit(1)
  .single();

let timeRemaining = null;
let timerStatus: 'not_started' | 'running' | 'paused' = 'not_started';

if (currentRoundMatch?.started_at) {
  const startTime = new Date(currentRoundMatch.started_at);
  const pausedSeconds = currentRoundMatch.total_paused_seconds || 0;
  
  if (currentRoundMatch.paused_at) {
    // Timer is paused
    timerStatus = 'paused';
    const pausedTime = new Date(currentRoundMatch.paused_at);
    const elapsedSeconds = (pausedTime.getTime() - startTime.getTime()) / 1000 - pausedSeconds;
    timeRemaining = tournament.round_duration_minutes - (elapsedSeconds / 60);
  } else {
    // Timer is running
    timerStatus = 'running';
    const now = new Date();
    const elapsedSeconds = (now.getTime() - startTime.getTime()) / 1000 - pausedSeconds;
    timeRemaining = tournament.round_duration_minutes - (elapsedSeconds / 60);
  }
} else {
  // Timer not started
  timerStatus = 'not_started';
  timeRemaining = tournament.round_duration_minutes;
}

// Pass to client component for countdown display and controls
```

### Step 5: Add Round Timer Controls (Start/Pause/Resume)

**File:** `app/tournament/actions.ts`

Add server actions for timer control:

1. **Start Round Timer:**
   - `startRoundTimer(tournamentId, roundNumber)`
   - Sets `started_at` on all matches in the round
   - Clears `paused_at` and resets `total_paused_seconds`

2. **Pause Round Timer:**
   - `pauseRoundTimer(tournamentId, roundNumber)`
   - Sets `paused_at` to current timestamp
   - Timer stops counting down

3. **Resume Round Timer:**
   - `resumeRoundTimer(tournamentId, roundNumber)`
   - Calculates paused duration
   - Adds to `total_paused_seconds`
   - Clears `paused_at` to resume counting

**Implementation:**
```typescript
export async function startRoundTimer(
  tournamentId: string,
  roundNumber: number
): Promise<{ success: boolean; message?: string }> {
  const supabase = await createClient();
  
  const now = new Date().toISOString();
  
  const { error } = await supabase
    .from('matches')
    .update({
      started_at: now,
      paused_at: null,
      total_paused_seconds: 0,
    })
    .eq('tournament_id', tournamentId)
    .eq('round_number', roundNumber);
  
  if (error) {
    return { success: false, message: error.message };
  }
  
  revalidatePath(`/tournament/${tournamentId}`);
  return { success: true };
}

export async function pauseRoundTimer(
  tournamentId: string,
  roundNumber: number
): Promise<{ success: boolean; message?: string }> {
  const supabase = await createClient();
  
  const now = new Date().toISOString();
  
  const { error } = await supabase
    .from('matches')
    .update({ paused_at: now })
    .eq('tournament_id', tournamentId)
    .eq('round_number', roundNumber)
    .is('paused_at', null); // Only if not already paused
  
  if (error) {
    return { success: false, message: error.message };
  }
  
  revalidatePath(`/tournament/${tournamentId}`);
  return { success: true };
}

export async function resumeRoundTimer(
  tournamentId: string,
  roundNumber: number
): Promise<{ success: boolean; message?: string }> {
  const supabase = await createClient();
  
  // Get current state
  const { data: match } = await supabase
    .from('matches')
    .select('started_at, paused_at, total_paused_seconds')
    .eq('tournament_id', tournamentId)
    .eq('round_number', roundNumber)
    .not('paused_at', 'is', null)
    .limit(1)
    .single();
  
  if (!match || !match.paused_at) {
    return { success: false, message: 'Timer not paused' };
  }
  
  // Calculate paused duration
  const pausedDuration = Math.floor(
    (new Date(match.paused_at).getTime() - new Date(match.started_at).getTime()) / 1000
  ) - (match.total_paused_seconds || 0);
  
  const newTotalPaused = (match.total_paused_seconds || 0) + pausedDuration;
  
  // Resume timer
  const { error } = await supabase
    .from('matches')
    .update({
      paused_at: null,
      total_paused_seconds: newTotalPaused,
    })
    .eq('tournament_id', tournamentId)
    .eq('round_number', roundNumber);
  
  if (error) {
    return { success: false, message: error.message };
  }
  
  revalidatePath(`/tournament/${tournamentId}`);
  return { success: true };
}
```

### Step 6: Update Match Reporting for Draws

**File:** `app/tournament/actions.ts`

Modify `submitResult` function to support draws:

1. **Add Draw Option:**
   - Update function signature: `submitResult(matchId, resultType, playerIds, tournamentId)`
   - `resultType` can be: 'win', 'draw', or 'time-draw'
   - For draws, set both players to `result = 'draw'`

2. **Manual Draws Only:**
   - No automatic time-based draws
   - Players can manually report draws if needed
   - Draws are reported the same way as wins/losses

**Implementation:**
```typescript
export async function submitDraw(
  matchId: string,
  playerIds: string[],
  tournamentId: string
): Promise<SubmitResultResult> {
  const supabase = await createClient();
  
  // Set all participants to draw
  for (const playerId of playerIds) {
    await supabase
      .from('match_participants')
      .update({ result: 'draw' })
      .eq('match_id', matchId)
      .eq('player_id', playerId);
  }
  
  // Check round completion and generate next round if needed
  // ... (same logic as submitResult)
}
```

### Step 7: Update Tournament Bracket Display

**File:** `app/tournament/[id]/page.tsx`

Add standings display showing points:

1. **Standings Table:**
   - Display player name, points, wins, losses, draws
   - Sort by points (descending), then wins (descending), then losses (ascending)
   - Highlight current user's row

2. **Draft Seat Display:**
   - Show draft seat number next to player name in bracket
   - Visual indicator of seat positions (optional: visual table layout)

**Query for Standings:**
```typescript
const { data: participants } = await supabase
  .from('tournament_participants')
  .select('player_id, draft_seat, players(name)')
  .eq('tournament_id', tournamentId);

// Calculate points for each participant
// ... (use query pattern from DATABASE_STRUCTURE.md)
```

### Step 8: Update Tournament Setup Form

**File:** `components/tournament/tournament-setup-form.tsx`

Add round duration input:

1. **Round Duration Field:**
   - Default: 50 minutes (standard MTG draft round)
   - Allow customization: 30-90 minutes
   - Pass to `createTournament` action

2. **Draft Seat Preview:**
   - Show visual preview of draft table layout
   - Display which players will be paired in Round 1

## Testing Checklist

- [ ] Create tournament with 8 players - verify draft seats assigned 1-8
- [ ] Verify Round 1 pairings: seat 1 vs 5, seat 2 vs 6, etc.
- [ ] Test with odd number of players (7 players) - verify bye handling
- [ ] Report win - verify 3 points awarded
- [ ] Report draw - verify 2 points awarded
- [ ] Report loss - verify 1 point awarded
- [ ] Verify standings sort correctly by points
- [ ] Test round timer countdown display
- [ ] Test "Start Round" button functionality
- [ ] Test "Pause" button functionality
- [ ] Test "Resume" button functionality
- [ ] Verify timer shows correct time after pause/resume
- [ ] Verify timer is informational only (no auto-draws)
- [ ] Verify Round 2+ uses Swiss pairings based on points
- [ ] Test tournament completion - verify winner has highest points

## Edge Cases

### Odd Number of Players
- Assign draft seats 1 through N
- Last seat (N) gets bye in Round 1
- Round 2+ uses normal Swiss pairings

### Round Timer Expiry
- When timer reaches 0, display "Time Expired" but take no automatic action
- Timer is informational only - players can still report results manually
- Tournament organizer can manually pause/resume timer as needed

### Tiebreakers
- Primary: Total points
- Secondary: Wins
- Tertiary: Losses (fewer is better)
- Future: Head-to-head record, opponent match win percentage

## Database Changes Summary

1. **New Table:** `tournament_participants`
   - Tracks draft seat assignments
   - Links players to tournaments

2. **Tournaments Table:**
   - Added `round_duration_minutes` (default: 50) - set at tournament creation

3. **Matches Table:**
   - Added `started_at` timestamp - set when "Start Round" is clicked
   - Added `paused_at` timestamp - set when timer is paused (NULL when running)
   - Added `total_paused_seconds` - cumulative paused time across pause/resume cycles

## UI/UX Changes

1. **Tournament Creation:**
   - Add round duration input (default: 50 minutes)
   - Show draft seat preview
   - Note: Timer is not started automatically - must be started manually

2. **Tournament Bracket:**
   - Display round timer with countdown
   - Show "Start Round" button if timer not started
   - Show "Pause" button if timer is running
   - Show "Resume" button if timer is paused
   - Timer shows "Time Expired" when it reaches 0 (no automatic action)

2. **Tournament Bracket:**
   - Display round timer countdown
   - Show standings table with points
   - Display draft seat numbers

3. **Match Reporting:**
   - Add "Draw" button option (manual only, no automatic draws)
   - Show time remaining warning when < 5 minutes (informational only)

## References

- **Database Structure:** `.dev-docs/DATABASE_STRUCTURE.md`
- **Tournament Structure:** `.dev-docs/TOURNAMENT_STRUCTURE.md`
- **Tournament Rules:** `.dev-docs/TOURNAMENT_RULES.md`
- **Migration Scripts:** 
  - `.dev-docs/DATABASE_MIGRATION_draft_seats_and_timers.md`
  - `.dev-docs/DATABASE_MIGRATION_round_timer_controls.md`

