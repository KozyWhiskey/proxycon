# Feature: AI Gamification & "The Snarky Director" (V3)

**Status:** âœ… **COMPLETED**
**Role:** AI & Engagement
**Inspiration:** Dungeon Crawler Carl (The AI)
**Goal:** Create a dynamic, personalized, and humorous achievement system that reacts to player actions in real-time using OpenAI.

---

## Objective
Move beyond static badges ("Won 5 games") to dynamic, context-aware achievements generated by an LLM. The AI acts as a "Snarky Director," analyzing match data, deck choices (Commanders), and player history to award unique, funny, and sometimes mean badges.

---

## Core Architecture

### 1. The AI Persona
-   **Role:** The Director.
-   **Tone:** Snarky, observant, slightly sadistic, but ultimately fair. Loves chaos. Reference "Dungeon Crawler Carl" AI.
-   **Tech:** OpenAI (via Vercel AI SDK) with a rigid System Prompt.
-   **Output:** JSON structure `{ name, description, icon_search_term, rarity }`.

### 2. Triggers (The "Watcher")
The AI does not watch every move (too expensive). It is summoned by specific events in the `submitResult` action:
1.  **Commander First Win:** A player wins with a specific Commander for the first time *ever* in the system.
2.  **The Upset:** A low-win-rate deck (<30%) beats a high-win-rate deck (>70%).
3.  **The Stomp:** A 2-0 win where the total match duration was exceptionally short.
4.  **The Mirror:** Winning a match where both players share an identical color identity.

---

## The Hybrid Strategy

We will implement a **Hybrid Tiered System** that combines shared "Lore" badges with rare "Unique Feats".

### Tier 1: Signature Commander Badges (Shared Lore)
**Concept:** The AI generates *one* definitive "Roast/Badge" per Commander. Once generated, this badge becomes a permanent part of the system's "Pokedex" and can be earned by other players who win with that same Commander.

*   **Workflow:**
    1.  Player wins with "Atraxa, Praetors' Voice".
    2.  System checks DB: Does a badge exist with `metadata->commander_name = 'Atraxa, Praetors' Voice'`?
    3.  **If Yes:** Award existing badge.
    4.  **If No:**
        *   Fetch Commander details (Oracle text, Flavor text, Art style) from Scryfall.
        *   Send prompt to OpenAI: "Generate a snarky achievement for winning with [Commander]. Roast the playstyle (e.g., Proliferate spam)."
        *   AI Generates: *"The Arithmetic Nerd"* ("You like counting counters more than playing magic.").
        *   Save to `badges` table (marked `generated_by = 'ai'`).
        *   Award to player.

### Tier 2: "God Mode" Feats (Unique Moments)
**Concept:** Rare, one-off events trigger a unique "Feat" that is specific to that match and moment. These are NOT reused.

*   **Workflow:**
    1.  Trigger: "The Upset" (David vs Goliath).
    2.  Send prompt to OpenAI with Match Context (Decks, Players, Scores).
    3.  AI Generates: *"The Giant Slayer"* ("You beat the meta deck with a pile of commons. We are all surprised, mostly me.").
    4.  Save to `profile_badges` with `is_unique = true` and custom metadata.

---

## Implementation Plan

### Phase 1: Database Schema Updates
We need to enhance the schema to support dynamic generation and linking.

-   **Table:** `badges`
    -   `generated_by` (TEXT): 'system' | 'ai'.
    -   `metadata` (JSONB): Stores `{ commander_name, set_code, criteria }` to link badges to game objects without strict FKs.
-   **Table:** `profile_badges`
    -   `is_unique` (BOOLEAN): Defaults to `false`. If `true`, this is a "God Mode" feat.
    -   `custom_title` (TEXT, NULLABLE): Overrides the base badge name (for unique feats).
    -   `custom_description` (TEXT, NULLABLE): Overrides the base description.

### Phase 2: The AI Director (`lib/ai-director.ts`)
-   **Setup:** Configure `openai` client using Vercel AI SDK.
-   **Function:** `generateCommanderBadge(cardData: ScryfallCard)`
    -   Constructs the "Snarky" system prompt.
    -   Parses JSON response.
-   **Function:** `generateMatchFeat(matchData: MatchContext)`
    -   Analyzes match for "God Mode" triggers.

### Phase 3: The Hook (`app/tournament/actions.ts`)
-   In `submitResult`, after the transaction:
    -   **Async Check:** Check if the winner's Commander has a badge.
    -   **If Missing:** Call `generateCommanderBadge` -> Insert to DB -> Award.
    -   **If Present:** Award existing.
    -   **Performance:** Use `unstable_after` (Next.js 15/16) or simply await (if acceptable delay ~1-2s) to ensure the toast appears.

### Phase 4: Scryfall Context
-   Update `lib/scryfall.ts` to ensure we have easy access to "Flavor Text" and "Oracle Text" when passing context to the AI. This is crucial for high-quality roasts.