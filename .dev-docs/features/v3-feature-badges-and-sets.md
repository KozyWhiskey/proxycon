# Feature: Badges & Sets Overhaul (V3)

**Status:** Planned
**Role:** Gamification & Content
**Goal:** Refactor the badge system to correctly distinguish between Constructed (Commander) and Limited (Draft/Sealed) contexts, and expand AI generation to include Magic Sets.

---

## 1. Casual Mode Integration

**Problem:** Currently, casual games (Commander, 1v1) do not trigger any badge logic. Players playing their favorite decks in casual games are missing out on "Commander Roast" badges.

**Changes Required:**
1.  **Update `logCasualMatch` (`app/play/actions.ts`):**
    -   After successfully logging a match, invoke the badge checking logic.
    -   Call `checkAndAwardBadges` for "Hot Hand" type streaks.
    -   Call `checkAndAwardCommanderBadge` for the winner(s) if they selected a deck.
    -   Ensure `awardedBadges` are returned to the client for toast notifications.

---

## 2. Tournament Sets & Limited Badges

**Problem:** Tournaments currently trigger Commander-based badges. In Draft/Sealed, players don't use their constructed decks, so "Commander Roasts" make no sense. Instead, we want to celebrate the **Set** being played (e.g., "Bloomburrow Champion").

**Architecture Changes:**
1.  **Database Migration:**
    -   Add `set_code` (TEXT) and `set_name` (TEXT) to the `tournaments` table.
2.  **Tournament Setup UI (`app/tournament/new`):**
    -   Add a "Expansion Set" selector powered by Scryfall (`/sets` API).
    -   Store the selected set in the new DB columns.
3.  **Badge Logic Refactor:**
    -   **Constructed Tournaments:** Continue using Commander/Deck badges if the format implies it (though V3 tournaments are primarily Draft/Sealed).
    -   **Limited Tournaments (Draft/Sealed):**
        -   **Disable** `checkAndAwardCommanderBadge`.
        -   **Enable** `checkAndAwardSetBadge`.
4.  **AI Director Update:**
    -   Create `generateSetBadge(set: ScryfallSet)` function.
    -   Prompt: "Generate a snarky achievement for winning a draft of [Set Name]. Roast the set's mechanics or themes."

---

## 3. The "Watcher" (Match Feats)

**Problem:** The AI currently only reacts to Commander wins. We want it to react to specific gameplay scenarios ("God Mode" feats).

**New Triggers (`lib/ai-director.ts`):**
1.  **"The Upset":**
    -   Logic: Winner's win rate < 30% AND Loser's win rate > 70%.
    -   Badge: Generated by AI ("The Giant Slayer").
2.  **"The Stomp":**
    -   Logic: Score is 2-0 AND Match Duration < 15 minutes.
    -   Badge: Generated by AI ("Speed Demon").
3.  **"The Mirror":**
    -   Logic: Both players share identical color identities (e.g., Izzet vs Izzet).
    -   Badge: Generated by AI ("There Can Be Only One").

---

## 4. Implementation Plan

### Phase 1: Casual Integration (Immediate)
-   Refactor `logCasualMatch` to await badge generation.
-   Update `checkAndAwardCommanderBadge` to work with casual match context.

### Phase 2: Sets Data & UI
-   Create `fetchSets` utility in `lib/scryfall.ts`.
-   Update `tournaments` schema.
-   Update `CreateTournament` form to include Set selection.

### Phase 3: Set Badges & AI
-   Implement `generateSetBadge` in AI Director.
-   Update `submitResult` to switch strategies based on `tournament.format`.

### Phase 4: The Watcher
-   Implement `generateMatchFeat` and hook it into `submitResult`.
